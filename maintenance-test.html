<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîß Test Sistema de Mantenimiento - Zeus Balneario</title>
    <link rel="stylesheet" href="src/css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* Estilos espec√≠ficos para el test de mantenimiento */
        .maintenance-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .maintenance-header {
            background: linear-gradient(135deg, #ff6b35 0%, #f7931e 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 30px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
        }

        .maintenance-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .maintenance-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            border-left: 4px solid #ff6b35;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .maintenance-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        }

        .maintenance-card h3 {
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .resource-item {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .resource-item:hover {
            border-color: #ff6b35;
            background: #fff;
        }

        .resource-item.out-of-service {
            background: #ffe6e6;
            border-color: #dc3545;
            color: #721c24;
        }

        .resource-item.maintenance-scheduled {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
        }

        .resource-item.needs-attention {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
            animation: pulse 2s infinite;
        }

        .resource-item.occupied {
            background: #cce5ff;
            border-color: #007bff;
            color: #004085;
            font-weight: bold;
        }

        .resource-item.occupied::after {
            content: "üë§";
            position: absolute;
            top: 5px;
            right: 5px;
            font-size: 12px;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .resource-status {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            border-radius: 50%;
            border: 2px solid white;
        }

        .status-available { background: #28a745; }
        .status-occupied { background: #007bff; }
        .status-maintenance { background: #dc3545; }
        .status-scheduled { background: #ffc107; }

        .quick-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .maintenance-btn {
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .maintenance-btn:hover {
            background: #e55a2b;
            transform: translateY(-1px);
        }

        .maintenance-btn.secondary {
            background: #6c757d;
        }

        .maintenance-btn.secondary:hover {
            background: #5a6268;
        }

        .maintenance-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: white;
        }

        .maintenance-item {
            padding: 15px;
            border-bottom: 1px solid #f8f9fa;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }

        .maintenance-item:last-child {
            border-bottom: none;
        }

        .maintenance-info h4 {
            margin: 0 0 5px 0;
            color: #2c3e50;
        }

        .maintenance-info p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }

        .maintenance-priority {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .priority-high { background: #dc3545; color: white; }
        .priority-medium { background: #ffc107; color: #856404; }
        .priority-low { background: #28a745; color: white; }

        .maintenance-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            margin: 50px auto;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: #ff6b35;
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 30px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2c3e50;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .form-control:focus {
            outline: none;
            border-color: #ff6b35;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-top: 4px solid #ff6b35;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #ff6b35;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .maintenance-grid {
                grid-template-columns: 1fr;
            }
            
            .resource-grid {
                grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <div class="maintenance-container">
        <!-- Header -->
        <div class="maintenance-header">
            <h1><i class="fas fa-tools"></i> Sistema de Mantenimiento - Zeus Balneario</h1>
            <p>Gesti√≥n integral de mantenimiento con datos reales del sistema</p>
        </div>

        <!-- Acciones R√°pidas -->
        <div class="maintenance-card">
            <h3><i class="fas fa-bolt"></i> Acciones R√°pidas de Mantenimiento</h3>
            <div class="quick-actions">
                <button class="maintenance-btn" onclick="markOutOfService()">
                    <i class="fas fa-exclamation-triangle"></i> Marcar Fuera de Servicio
                </button>
                <button class="maintenance-btn" onclick="scheduleMaintenance()">
                    <i class="fas fa-calendar-plus"></i> Programar Mantenimiento
                </button>
                <button class="maintenance-btn" onclick="completeMaintenance()">
                    <i class="fas fa-check-circle"></i> Completar Trabajo
                </button>
                <button class="maintenance-btn secondary" onclick="generateReport()">
                    <i class="fas fa-file-alt"></i> Generar Reporte
                </button>
                <button class="maintenance-btn secondary" onclick="resetTestData()" title="Resetear datos de prueba">
                    <i class="fas fa-refresh"></i> Resetear Test
                </button>
            </div>
            
            <!-- Info de Debug -->
            <div id="debugInfo" style="margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 6px; font-size: 12px; color: #666;">
                <strong>üìã Debug Info:</strong>
                <div id="debugContent">Cargando...</div>
            </div>
        </div>

        <div class="maintenance-grid">
            <!-- Estado Actual de Recursos -->
            <div class="maintenance-card">
                <h3><i class="fas fa-chart-pie"></i> Estado Actual de Recursos</h3>
                <div id="resourcesGrid" class="resource-grid">
                    <!-- Se llena din√°micamente -->
                </div>
                <div style="margin-top: 15px;">
                    <small><i class="fas fa-circle status-available"></i> Disponible</small>
                    <small><i class="fas fa-circle status-occupied" style="margin-left: 15px;"></i> Ocupado</small>
                    <small><i class="fas fa-circle status-maintenance" style="margin-left: 15px;"></i> Mantenimiento</small>
                    <small><i class="fas fa-circle status-scheduled" style="margin-left: 15px;"></i> Programado</small>
                </div>
            </div>

            <!-- Tareas Pendientes -->
            <div class="maintenance-card">
                <h3><i class="fas fa-list-check"></i> Tareas de Mantenimiento Pendientes</h3>
                <div id="maintenanceList" class="maintenance-list">
                    <!-- Se llena din√°micamente -->
                </div>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalResources">0</div>
                <div class="stat-label">Total Recursos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="availableResources">0</div>
                <div class="stat-label">Disponibles</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="maintenanceResources">0</div>
                <div class="stat-label">En Mantenimiento</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingTasks">0</div>
                <div class="stat-label">Tareas Pendientes</div>
            </div>
        </div>
    </div>

    <!-- Modal para Mantenimiento -->
    <div id="maintenanceModal" class="maintenance-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle"><i class="fas fa-wrench"></i> Nueva Tarea de Mantenimiento</h3>
                <button onclick="closeModal()" style="background: none; border: none; color: white; font-size: 24px; cursor: pointer;">√ó</button>
            </div>
            <div class="modal-body">
                <form id="maintenanceForm">
                    <div class="form-group">
                        <label for="resourceSelect">Recurso Afectado:</label>
                        <select id="resourceSelect" name="resourceSelect" class="form-control" required>
                            <option value="">Seleccionar recurso...</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="issueType">Tipo de Problema:</label>
                        <select id="issueType" name="issueType" class="form-control" required>
                            <option value="">Seleccionar tipo...</option>
                            <option value="structural">Estructural</option>
                            <option value="cleaning">Limpieza</option>
                            <option value="electrical">El√©ctrico</option>
                            <option value="plumbing">Plomer√≠a</option>
                            <option value="equipment">Equipamiento</option>
                            <option value="safety">Seguridad</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="priority">Prioridad:</label>
                        <select id="priority" name="priority" class="form-control" required>
                            <option value="low">üü¢ Baja - Puede esperar</option>
                            <option value="medium" selected>üü° Media - Resolver hoy</option>
                            <option value="high">üî¥ Alta - Urgente</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="description">Descripci√≥n del Problema:</label>
                        <textarea id="description" name="description" class="form-control" rows="3" required placeholder="Describe detalladamente el problema encontrado..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="scheduledDate">Fecha Programada:</label>
                        <input type="datetime-local" id="scheduledDate" name="scheduledDate" class="form-control">
                    </div>

                    <div class="form-group">
                        <label for="estimatedTime">Tiempo Estimado (minutos):</label>
                        <select id="estimatedTime" name="estimatedTime" class="form-control">
                            <option value="15">15 minutos</option>
                            <option value="30">30 minutos</option>
                            <option value="60" selected>1 hora</option>
                            <option value="120">2 horas</option>
                            <option value="240">4 horas</option>
                            <option value="480">8 horas (d√≠a completo)</option>
                        </select>
                    </div>

                    <div style="text-align: center; margin-top: 30px;">
                        <button type="button" onclick="closeModal()" class="maintenance-btn secondary">
                            <i class="fas fa-times"></i> Cancelar
                        </button>
                        <button type="submit" class="maintenance-btn" style="margin-left: 15px;">
                            <i class="fas fa-save"></i> Guardar Tarea
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Scripts del sistema real -->
    <script src="src/js/config.js"></script>
    <script src="src/js/storage.js"></script>
    
    <script>
        // Sistema de Mantenimiento integrado con datos reales
        class MaintenanceSystem {
            constructor() {
                this.maintenanceTasks = this.loadMaintenanceTasks();
                this.resourceStatus = this.loadResourceStatus();
                this.init();
            }

            init() {
                this.loadRealResourcesConfig();
                this.debugConfiguration(); // Debug para verificar datos
                this.renderResourcesGrid();
                this.renderMaintenanceList();
                this.updateStats();
                this.setupEventListeners();
            }

            // Debug para verificar configuraci√≥n cargada
            debugConfiguration() {
                console.log('üîç DEBUG - Configuraci√≥n cargada:');
                console.log('üìã Recursos:', this.resources);
                console.log('üè† localStorage zeus-establishment-config:', localStorage.getItem('zeus-establishment-config'));
                console.log('üì¶ localStorage zeus-rentals:', localStorage.getItem('zeus-rentals'));
                
                // Si no hay configuraci√≥n, crear una de prueba
                this.ensureTestConfiguration();
                
                const currentRentals = this.getCurrentRentals();
                console.log('üìä Alquileres de hoy:', currentRentals);
                
                // Mostrar info en la UI
                this.updateDebugInfo();
            }

            // Actualizar informaci√≥n de debug en la UI
            updateDebugInfo() {
                const debugContent = document.getElementById('debugContent');
                if (!debugContent) return;

                const currentRentals = this.getCurrentRentals();
                const resourceCount = Object.keys(this.resources).length;
                const totalUnits = Object.values(this.resources).reduce((sum, r) => sum + r.total, 0);
                
                debugContent.innerHTML = `
                    <div>üì¶ Recursos configurados: ${resourceCount} tipos, ${totalUnits} unidades total</div>
                    <div>üèñÔ∏è Alquileres activos hoy: ${currentRentals.length}</div>
                    <div>üîß Tareas de mantenimiento: ${this.maintenanceTasks.length}</div>
                    <div>üíæ Config en localStorage: ${localStorage.getItem('zeus-establishment-config') ? '‚úÖ' : '‚ùå'}</div>
                `;
            }

            // Asegurar que hay configuraci√≥n de prueba para el test
            ensureTestConfiguration() {
                const existingConfig = localStorage.getItem('zeus-establishment-config');
                
                if (!existingConfig || existingConfig === 'null') {
                    console.log('üîß Creando configuraci√≥n de prueba...');
                    
                    const testConfig = {
                        establishmentName: "Zeus Balneario",
                        resources: [
                            { type: "sombrilla", quantity: 25 },
                            { type: "carpa", quantity: 15 },
                            { type: "estacionamiento", quantity: 20 }
                        ]
                    };
                    
                    localStorage.setItem('zeus-establishment-config', JSON.stringify(testConfig));
                    
                    // Recargar configuraci√≥n
                    this.loadRealResourcesConfig();
                    
                    console.log('‚úÖ Configuraci√≥n de prueba creada');
                }

                // Si no hay alquileres de prueba, crear algunos
                const existingRentals = localStorage.getItem('zeus-rentals');
                if (!existingRentals || existingRentals === '[]') {
                    console.log('üìä Creando alquileres de prueba...');
                    
                    const today = new Date().toISOString().split('T')[0];
                    const testRentals = [
                        {
                            id: "test-001",
                            type: "sombrilla",        // ‚úÖ Formato correcto del sistema Zeus
                            unitNumber: 5,            // ‚úÖ Formato correcto del sistema Zeus
                            startDate: today,
                            endDate: today,
                            clientName: "Juan P√©rez",
                            clientPhone: "2262123456",
                            clientDNI: "12345678",
                            pricePerDay: 8000,
                            paymentMethod: "efectivo",
                            paymentStatus: "pagado",
                            status: "active",
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: "test-002", 
                            type: "carpa",            // ‚úÖ Formato correcto del sistema Zeus
                            unitNumber: 12,           // ‚úÖ Formato correcto del sistema Zeus
                            startDate: today,
                            endDate: today,
                            clientName: "Mar√≠a Gonz√°lez",
                            clientPhone: "2262654321",
                            clientDNI: "87654321",
                            pricePerDay: 12000,
                            paymentMethod: "transferencia",
                            paymentStatus: "pagado",
                            status: "active",
                            createdAt: new Date().toISOString()
                        },
                        {
                            id: "test-003",
                            type: "estacionamiento",  // ‚úÖ Formato correcto del sistema Zeus
                            unitNumber: 8,            // ‚úÖ Formato correcto del sistema Zeus
                            startDate: today,
                            endDate: today,
                            clientName: "Carlos L√≥pez",
                            clientPhone: "2262987654",
                            clientDNI: "11223344",
                            pricePerDay: 3000,
                            paymentMethod: "mercadopago",
                            paymentStatus: "pagado",
                            status: "active",
                            createdAt: new Date().toISOString()
                        }
                    ];
                    
                    localStorage.setItem('zeus-rentals', JSON.stringify(testRentals));
                    console.log('‚úÖ Alquileres de prueba creados con formato correcto');
                }
            }

            // Cargar configuraci√≥n real de recursos
            loadRealResourcesConfig() {
                try {
                    // Usar la funci√≥n getResourcesConfig() del sistema Zeus
                    const resourcesConfig = typeof getResourcesConfig === 'function' ? getResourcesConfig() : null;
                    
                    if (resourcesConfig && Object.keys(resourcesConfig).length > 0) {
                        this.resources = resourcesConfig;
                        console.log('‚úÖ Configuraci√≥n de recursos cargada:', this.resources);
                    } else {
                        // Intentar cargar desde localStorage directamente
                        const establishmentConfig = localStorage.getItem('zeus-establishment-config');
                        if (establishmentConfig) {
                            const config = JSON.parse(establishmentConfig);
                            if (config && config.resources && config.resources.length > 0) {
                                // Convertir formato de establecimiento a formato de recursos
                                this.resources = {};
                                config.resources.forEach(resource => {
                                    const typeMap = {
                                        'sombrilla': { prefix: 'S', icon: '‚òÇÔ∏è', label: 'Sombrillas' },
                                        'carpa': { prefix: 'C', icon: '‚õ∫', label: 'Carpas' }, 
                                        'estacionamiento': { prefix: 'E', icon: 'üöó', label: 'Estacionamiento' }
                                    };
                                    
                                    if (typeMap[resource.type]) {
                                        this.resources[resource.type] = {
                                            total: resource.quantity,
                                            prefix: typeMap[resource.type].prefix,
                                            icon: typeMap[resource.type].icon,
                                            label: typeMap[resource.type].label
                                        };
                                    }
                                });
                                console.log('‚úÖ Configuraci√≥n cargada desde localStorage:', this.resources);
                            } else {
                                throw new Error('No hay recursos configurados');
                            }
                        } else {
                            throw new Error('No hay configuraci√≥n en localStorage');
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Error cargando configuraci√≥n real, usando fallback:', error);
                    // Fallback con datos de ejemplo realistas
                    this.resources = {
                        sombrilla: { total: 25, prefix: 'S', icon: '‚òÇÔ∏è', label: 'Sombrillas' },
                        carpa: { total: 15, prefix: 'C', icon: '‚õ∫', label: 'Carpas' },
                        estacionamiento: { total: 20, prefix: 'E', icon: 'üöó', label: 'Estacionamiento' }
                    };
                    console.log('‚ÑπÔ∏è Usando configuraci√≥n de fallback');
                }
            }

            // Obtener alquileres actuales del sistema real
            getCurrentRentals() {
                try {
                    // Intentar usar funci√≥n getRentals del sistema
                    let rentals = [];
                    if (typeof getRentals === 'function') {
                        rentals = getRentals();
                    } else {
                        // Obtener directamente desde localStorage
                        const data = localStorage.getItem('zeus-rentals');
                        rentals = data ? JSON.parse(data) : [];
                    }
                    
                    const today = new Date().toISOString().split('T')[0];
                    const currentRentals = rentals.filter(rental => {
                        // Verificar que el alquiler est√© activo hoy
                        if (!rental.startDate || rental.status === 'cancelled') return false;
                        
                        const startDate = new Date(rental.startDate).toISOString().split('T')[0];
                        const endDate = rental.endDate ? new Date(rental.endDate).toISOString().split('T')[0] : startDate;
                        
                        // El alquiler est√° activo si hoy est√° entre startDate y endDate (inclusive)
                        const isActiveToday = today >= startDate && today <= endDate;
                        
                        console.log(`üìä Alquiler ${rental.id}: start=${startDate}, end=${endDate}, today=${today}, active=${isActiveToday}`);
                        
                        return isActiveToday;
                    });
                    
                    console.log(`üìä Alquileres actuales encontrados: ${currentRentals.length}`);
                    return currentRentals;
                } catch (error) {
                    console.error('‚ùå Error obteniendo alquileres:', error);
                    return [];
                }
            }

            // Renderizar grilla de recursos con datos reales
            renderResourcesGrid() {
                const container = document.getElementById('resourcesGrid');
                const currentRentals = this.getCurrentRentals();
                let html = '';

                Object.keys(this.resources).forEach(resourceType => {
                    const config = this.resources[resourceType];
                    
                    for (let i = 1; i <= config.total; i++) {
                        const resourceId = `${config.prefix}${i.toString().padStart(2, '0')}`;
                        
                        // Verificar si est√° ocupado (formato real del sistema Zeus)
                        const isOccupied = currentRentals.some(rental => {
                            // El sistema Zeus usa: rental.type y rental.unitNumber
                            const matchesType = rental.type === resourceType;
                            const matchesNumber = rental.unitNumber === i;
                            
                            console.log(`üîç Verificando ${resourceId}: rental.type=${rental.type}, resourceType=${resourceType}, rental.unitNumber=${rental.unitNumber}, i=${i}`);
                            
                            return matchesType && matchesNumber;
                        });
                        
                        // Verificar estado de mantenimiento
                        const maintenanceStatus = this.getResourceMaintenanceStatus(resourceId);
                        
                        let cssClass = 'resource-item';
                        let statusClass = 'status-available';
                        let statusText = 'Disponible';
                        
                        if (maintenanceStatus === 'out-of-service') {
                            cssClass += ' out-of-service';
                            statusClass = 'status-maintenance';
                            statusText = 'Fuera de servicio';
                        } else if (maintenanceStatus === 'scheduled') {
                            cssClass += ' maintenance-scheduled';
                            statusClass = 'status-scheduled';
                            statusText = 'Mant. programado';
                        } else if (isOccupied) {
                            cssClass += ' occupied';
                            statusClass = 'status-occupied';
                            statusText = 'Ocupado';
                        }

                        html += `
                            <div class="${cssClass}" onclick="selectResource('${resourceId}', '${resourceType}', ${isOccupied})">
                                <div class="resource-status ${statusClass}"></div>
                                <div style="font-size: 24px; margin-bottom: 5px;">${config.icon}</div>
                                <strong>${resourceId}</strong>
                                <div style="font-size: 12px; color: #666;">
                                    ${statusText}
                                </div>
                            </div>
                        `;
                    }
                });

                container.innerHTML = html;

                // Poblar selector de recursos en modal
                this.populateResourceSelect();
            }

            // Poblar selector de recursos en modal
            populateResourceSelect() {
                const select = document.getElementById('resourceSelect');
                let options = '<option value="">Seleccionar recurso...</option>';

                Object.keys(this.resources).forEach(resourceType => {
                    const config = this.resources[resourceType];
                    options += `<optgroup label="${config.label}">`;
                    
                    for (let i = 1; i <= config.total; i++) {
                        const resourceId = `${config.prefix}${i.toString().padStart(2, '0')}`;
                        options += `<option value="${resourceId}">${resourceId} - ${config.label}</option>`;
                    }
                    options += '</optgroup>';
                });

                select.innerHTML = options;
            }

            // Obtener estado de mantenimiento de un recurso
            getResourceMaintenanceStatus(resourceId) {
                const task = this.maintenanceTasks.find(task => 
                    task.resourceId === resourceId && task.status !== 'completed'
                );
                
                if (!task) return 'available';
                
                if (task.status === 'out-of-service') return 'out-of-service';
                if (task.status === 'scheduled') return 'scheduled';
                
                return 'available';
            }

            // Renderizar lista de tareas de mantenimiento
            renderMaintenanceList() {
                const container = document.getElementById('maintenanceList');
                const pendingTasks = this.maintenanceTasks.filter(task => task.status !== 'completed');
                
                if (pendingTasks.length === 0) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #6c757d;">
                            <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
                            <p>¬°Excelente! No hay tareas de mantenimiento pendientes.</p>
                        </div>
                    `;
                    return;
                }

                let html = '';
                pendingTasks.forEach(task => {
                    const priorityClass = `priority-${task.priority}`;
                    const priorityText = {
                        high: 'Alta',
                        medium: 'Media', 
                        low: 'Baja'
                    }[task.priority] || 'Media';

                    const issueTypeText = {
                        'structural': 'Estructural',
                        'cleaning': 'Limpieza',
                        'electrical': 'El√©ctrico', 
                        'plumbing': 'Plomer√≠a',
                        'equipment': 'Equipamiento',
                        'safety': 'Seguridad',
                        'other': 'Otro'
                    }[task.issueType] || task.issueType || 'Sin especificar';

                    html += `
                        <div class="maintenance-item">
                            <div class="maintenance-info">
                                <h4>${task.resourceId || 'Sin recurso'} - ${issueTypeText}</h4>
                                <p>${task.description || 'Sin descripci√≥n'}</p>
                                <small>
                                    <i class="fas fa-calendar"></i> 
                                    ${task.scheduledDate ? new Date(task.scheduledDate).toLocaleString() : 'Sin programar'}
                                    ${task.estimatedTime ? ` ‚Ä¢ ${task.estimatedTime} min` : ''}
                                </small>
                            </div>
                            <div style="text-align: right;">
                                <div class="maintenance-priority ${priorityClass}">
                                    ${priorityText}
                                </div>
                                <div style="margin-top: 10px;">
                                    <button class="maintenance-btn" style="padding: 5px 10px; font-size: 12px;" 
                                            onclick="completeTask('${task.id}')">
                                        <i class="fas fa-check"></i> Completar
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });

                container.innerHTML = html;
            }

            // Actualizar estad√≠sticas
            updateStats() {
                const currentRentals = this.getCurrentRentals();
                let totalResources = 0;
                let availableResources = 0;
                let maintenanceResources = 0;

                Object.keys(this.resources).forEach(resourceType => {
                    const config = this.resources[resourceType];
                    totalResources += config.total;

                    for (let i = 1; i <= config.total; i++) {
                        const resourceId = `${config.prefix}${i.toString().padStart(2, '0')}`;
                        const isOccupied = currentRentals.some(rental => 
                            rental.unitType === resourceType && rental.unitNumber === i
                        );
                        const maintenanceStatus = this.getResourceMaintenanceStatus(resourceId);

                        if (maintenanceStatus !== 'available') {
                            maintenanceResources++;
                        } else if (!isOccupied) {
                            availableResources++;
                        }
                    }
                });

                const pendingTasks = this.maintenanceTasks.filter(task => task.status !== 'completed').length;

                document.getElementById('totalResources').textContent = totalResources;
                document.getElementById('availableResources').textContent = availableResources;
                document.getElementById('maintenanceResources').textContent = maintenanceResources;
                document.getElementById('pendingTasks').textContent = pendingTasks;
            }

            // Cargar tareas de mantenimiento
            loadMaintenanceTasks() {
                try {
                    const tasks = localStorage.getItem('zeus-maintenance-tasks');
                    return tasks ? JSON.parse(tasks) : this.generateSampleTasks();
                } catch (error) {
                    console.error('‚ùå Error cargando tareas:', error);
                    return this.generateSampleTasks();
                }
            }

            // Generar tareas de ejemplo para el test
            generateSampleTasks() {
                return [
                    {
                        id: 'maint-001',
                        resourceId: 'S05',
                        issueType: 'structural',
                        priority: 'high',
                        description: 'Sombrilla con tela rasgada, necesita reemplazo urgente',
                        status: 'out-of-service',
                        scheduledDate: new Date(Date.now() + 2 * 60 * 60 * 1000).toISOString(),
                        estimatedTime: 60,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'maint-002', 
                        resourceId: 'C12',
                        issueType: 'cleaning',
                        priority: 'medium',
                        description: 'Carpa necesita limpieza profunda despu√©s del evento',
                        status: 'scheduled',
                        scheduledDate: new Date(Date.now() + 24 * 60 * 60 * 1000).toISOString(),
                        estimatedTime: 120,
                        createdAt: new Date().toISOString()
                    },
                    {
                        id: 'maint-003',
                        resourceId: 'E08',
                        issueType: 'equipment',
                        priority: 'low',
                        description: 'Revisar estado de la se√±alizaci√≥n del estacionamiento',
                        status: 'scheduled',
                        scheduledDate: new Date(Date.now() + 48 * 60 * 60 * 1000).toISOString(),
                        estimatedTime: 30,
                        createdAt: new Date().toISOString()
                    }
                ];
            }

            // Cargar estado de recursos
            loadResourceStatus() {
                try {
                    const status = localStorage.getItem('zeus-resource-status');
                    return status ? JSON.parse(status) : {};
                } catch (error) {
                    console.error('‚ùå Error cargando estado de recursos:', error);
                    return {};
                }
            }

            // Guardar tareas de mantenimiento
            saveMaintenanceTasks() {
                try {
                    localStorage.setItem('zeus-maintenance-tasks', JSON.stringify(this.maintenanceTasks));
                } catch (error) {
                    console.error('‚ùå Error guardando tareas:', error);
                }
            }

            // Configurar event listeners
            setupEventListeners() {
                document.getElementById('maintenanceForm').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleFormSubmit();
                });
            }

            // Manejar env√≠o de formulario
            handleFormSubmit() {
                // Obtener valores directamente de los elementos del formulario
                const resourceSelect = document.getElementById('resourceSelect');
                const issueType = document.getElementById('issueType');
                const priority = document.getElementById('priority');
                const description = document.getElementById('description');
                const scheduledDate = document.getElementById('scheduledDate');
                const estimatedTime = document.getElementById('estimatedTime');

                // Validar que los campos requeridos est√©n llenos
                if (!resourceSelect.value) {
                    alert('‚ùå Por favor selecciona un recurso');
                    return;
                }
                if (!issueType.value) {
                    alert('‚ùå Por favor selecciona el tipo de problema');
                    return;
                }
                if (!description.value.trim()) {
                    alert('‚ùå Por favor describe el problema');
                    return;
                }

                const task = {
                    id: 'maint-' + Date.now(),
                    resourceId: resourceSelect.value,
                    issueType: issueType.value,
                    priority: priority.value || 'medium',
                    description: description.value.trim(),
                    scheduledDate: scheduledDate.value || null,
                    estimatedTime: parseInt(estimatedTime.value) || 60,
                    status: scheduledDate.value ? 'scheduled' : 'pending',
                    createdAt: new Date().toISOString()
                };

                console.log('üîß Nueva tarea de mantenimiento:', task);

                this.maintenanceTasks.push(task);
                this.saveMaintenanceTasks();
                this.closeModal();
                this.refresh();

                // Mostrar confirmaci√≥n con detalles
                const issueTypeText = {
                    'structural': 'Estructural',
                    'cleaning': 'Limpieza', 
                    'electrical': 'El√©ctrico',
                    'plumbing': 'Plomer√≠a',
                    'equipment': 'Equipamiento',
                    'safety': 'Seguridad',
                    'other': 'Otro'
                }[task.issueType] || task.issueType;

                alert(`‚úÖ Tarea de mantenimiento creada:
üìç Recurso: ${task.resourceId}
üîß Tipo: ${issueTypeText}
üìã Descripci√≥n: ${task.description}
${task.scheduledDate ? `üìÖ Programado: ${new Date(task.scheduledDate).toLocaleString()}` : '‚è≥ Sin programar'}`);
            }

            // Completar tarea
            completeTask(taskId) {
                const taskIndex = this.maintenanceTasks.findIndex(task => task.id === taskId);
                if (taskIndex !== -1) {
                    this.maintenanceTasks[taskIndex].status = 'completed';
                    this.maintenanceTasks[taskIndex].completedAt = new Date().toISOString();
                    this.saveMaintenanceTasks();
                    this.refresh();
                    alert('‚úÖ Tarea completada exitosamente');
                }
            }

            // Marcar recurso fuera de servicio
            markOutOfService(resourceId) {
                if (!resourceId) {
                    resourceId = prompt('Ingrese el ID del recurso (ej: S05, C12, E08):');
                    if (!resourceId) return;
                }

                const description = prompt('Describe el problema:');
                if (!description) return;

                const task = {
                    id: 'maint-' + Date.now(),
                    resourceId: resourceId.toUpperCase(),
                    issueType: 'emergency',
                    priority: 'high',
                    description,
                    status: 'out-of-service',
                    createdAt: new Date().toISOString()
                };

                this.maintenanceTasks.push(task);
                this.saveMaintenanceTasks();
                this.refresh();
                alert(`üö® ${resourceId} marcado como FUERA DE SERVICIO`);
            }

            // Programar mantenimiento
            scheduleMaintenance() {
                document.getElementById('modalTitle').innerHTML = '<i class="fas fa-calendar-plus"></i> Programar Mantenimiento';
                document.getElementById('maintenanceModal').style.display = 'block';
            }

            // Completar mantenimiento
            completeMaintenance() {
                const pendingTasks = this.maintenanceTasks.filter(task => task.status !== 'completed');
                if (pendingTasks.length === 0) {
                    alert('‚ÑπÔ∏è No hay tareas pendientes para completar');
                    return;
                }

                let options = 'Selecciona la tarea completada:\n\n';
                pendingTasks.forEach((task, index) => {
                    options += `${index + 1}. ${task.resourceId} - ${task.description.substring(0, 50)}...\n`;
                });

                const selection = prompt(options + '\nIngresa el n√∫mero:');
                if (selection && !isNaN(selection)) {
                    const taskIndex = parseInt(selection) - 1;
                    if (taskIndex >= 0 && taskIndex < pendingTasks.length) {
                        this.completeTask(pendingTasks[taskIndex].id);
                    }
                }
            }

            // Generar reporte
            generateReport() {
                const total = this.maintenanceTasks.length;
                const pending = this.maintenanceTasks.filter(t => t.status !== 'completed').length;
                const completed = total - pending;
                const outOfService = this.maintenanceTasks.filter(t => t.status === 'out-of-service').length;

                alert(`üìä REPORTE DE MANTENIMIENTO

üîß Total de tareas: ${total}
‚è≥ Pendientes: ${pending} 
‚úÖ Completadas: ${completed}
üö® Fuera de servicio: ${outOfService}

${pending > 0 ? '‚ö†Ô∏è Hay tareas que requieren atenci√≥n' : '‚ú® Todo el mantenimiento est√° al d√≠a'}`);
            }

            // Cerrar modal
            closeModal() {
                document.getElementById('maintenanceModal').style.display = 'none';
                const form = document.getElementById('maintenanceForm');
                form.reset();
                
                // Resetear valores por defecto
                document.getElementById('priority').value = 'medium';
                document.getElementById('estimatedTime').value = '60';
            }

            // Refrescar vista
            refresh() {
                this.renderResourcesGrid();
                this.renderMaintenanceList();
                this.updateStats();
                this.updateDebugInfo();
            }
        }

        // Funciones globales
        let maintenanceSystem;

        window.addEventListener('DOMContentLoaded', () => {
            maintenanceSystem = new MaintenanceSystem();
        });

        function selectResource(resourceId, resourceType, isOccupied) {
            const status = maintenanceSystem.getResourceMaintenanceStatus(resourceId);
            const currentRentals = maintenanceSystem.getCurrentRentals();
            
            let message = `üìç Recurso: ${resourceId}\n`;
            message += `üè∑Ô∏è Tipo: ${resourceType}\n`;
            
            // Si est√° ocupado, mostrar informaci√≥n del cliente
            if (isOccupied) {
                const rental = currentRentals.find(r => 
                    r.type === resourceType && 
                    r.unitNumber === parseInt(resourceId.replace(/[A-Z]/g, ''))
                );
                
                if (rental) {
                    message += `üë§ Ocupado por: ${rental.clientName}\n`;
                    message += `ÔøΩ Tel√©fono: ${rental.clientPhone}\n`;
                    message += `üìÖ Desde: ${rental.startDate} hasta: ${rental.endDate}\n`;
                    message += `üí∞ Precio: $${rental.pricePerDay}/d√≠a\n\n`;
                    message += 'üîß OPCIONES DE MANTENIMIENTO:\n\n';
                    message += '1. üö® Marcar URGENTE (cliente presente)\n';
                    message += '2. üìÖ Programar para despu√©s del checkout\n'; 
                    message += '3. üìù Reportar problema al cliente\n';
                    message += '4. üìã Ver historial completo\n';
                } else {
                    message += `ÔøΩüìä Estado: Ocupado (sin detalles)\n\n`;
                }
            } else {
                message += `üìä Estado: ${status === 'available' ? 'Disponible' : 
                                        status === 'out-of-service' ? 'Fuera de servicio' : 'Mantenimiento programado'}\n\n`;
            }
            
            if (status === 'available') {
                if (isOccupied) {
                    const choice = prompt(message + '\nIngresa el n√∫mero de opci√≥n:');
                    
                    switch(choice) {
                        case '1':
                            // MARCAR URGENTE - Buscar rental actualizado
                            const unitNumber = parseInt(resourceId.replace(/[A-Z]/g, ''));
                            const currentRental = currentRentals.find(r => r.type === resourceType && r.unitNumber === unitNumber);
                            
                            const urgentDescription = prompt('üö® PROBLEMA URGENTE\n\nDescribe el problema que requiere atenci√≥n inmediata:');
                            if (urgentDescription) {
                                const clientInfo = currentRental ? ` (Cliente presente: ${currentRental.clientName})` : '';
                                const task = {
                                    id: 'urgent-' + Date.now(),
                                    resourceId: resourceId,
                                    issueType: 'emergency',
                                    priority: 'high',
                                    description: urgentDescription + clientInfo,
                                    status: 'pending',
                                    createdAt: new Date().toISOString()
                                };
                                
                                maintenanceSystem.maintenanceTasks.push(task);
                                maintenanceSystem.saveMaintenanceTasks();
                                maintenanceSystem.refresh();
                                alert(`üö® Problema URGENTE registrado para ${resourceId}\n\n‚ö° Tarea creada con prioridad ALTA\nüìã Descripci√≥n: ${urgentDescription}${clientInfo}`);
                            }
                            break;
                        case '2':
                            // PROGRAMAR DESPU√âS DEL CHECKOUT - Buscar rental actualizado
                            const unitNum = parseInt(resourceId.replace(/[A-Z]/g, ''));
                            const rentalData = currentRentals.find(r => r.type === resourceType && r.unitNumber === unitNum);
                            
                            if (rentalData && rentalData.endDate) {
                                // Calcular fecha de checkout + 2 horas
                                const checkoutDate = new Date(rentalData.endDate);
                                checkoutDate.setHours(14, 0, 0, 0); // 2 PM del d√≠a de checkout
                                
                                const scheduledDateTime = checkoutDate.toISOString().slice(0, 16);
                                
                                // Pre-llenar el modal
                                document.getElementById('resourceSelect').value = resourceId;
                                document.getElementById('scheduledDate').value = scheduledDateTime;
                                document.getElementById('description').value = `Mantenimiento programado despu√©s del checkout de ${rentalData.clientName}`;
                                document.getElementById('priority').value = 'medium';
                                
                                // Abrir modal
                                maintenanceSystem.scheduleMaintenance();
                            } else {
                                // Si no hay rental, programar para ma√±ana
                                const tomorrow = new Date();
                                tomorrow.setDate(tomorrow.getDate() + 1);
                                tomorrow.setHours(9, 0, 0, 0);
                                
                                const scheduledDateTime = tomorrow.toISOString().slice(0, 16);
                                
                                document.getElementById('resourceSelect').value = resourceId;
                                document.getElementById('scheduledDate').value = scheduledDateTime;
                                document.getElementById('description').value = `Mantenimiento programado para ${resourceId}`;
                                
                                maintenanceSystem.scheduleMaintenance();
                            }
                            break;
                        case '3':
                            // REPORTAR AL CLIENTE - Buscar rental actualizado
                            const clientUnitNum = parseInt(resourceId.replace(/[A-Z]/g, ''));
                            const clientRental = currentRentals.find(r => r.type === resourceType && r.unitNumber === clientUnitNum);
                            
                            if (clientRental) {
                                const clientReport = prompt(`üìù REPORTAR AL CLIENTE\n\nProblema a informar a ${clientRental.clientName}:`);
                                if (clientReport) {
                                    alert(`üìû Informar a ${clientRental.clientName} (${clientRental.clientPhone}):\n\n"${clientReport}"\n\n‚úÖ Mensaje para el cliente registrado`);
                                    
                                    // Crear tarea de seguimiento
                                    const followUpTask = {
                                        id: 'report-' + Date.now(),
                                        resourceId: resourceId,
                                        issueType: 'other',
                                        priority: 'low',
                                        description: `Reporte informado al cliente: ${clientReport} | Cliente: ${clientRental.clientName} (${clientRental.clientPhone})`,
                                        status: 'pending',
                                        createdAt: new Date().toISOString()
                                    };
                                    
                                    maintenanceSystem.maintenanceTasks.push(followUpTask);
                                    maintenanceSystem.saveMaintenanceTasks();
                                    maintenanceSystem.refresh();
                                }
                            } else {
                                alert('‚ùå No se encontraron datos del cliente para este recurso');
                            }
                            break;
                        case '4':
                            alert(`üìã Historial de ${resourceId}:\n\n(Funcionalidad en desarrollo)`);
                            break;
                    }
                } else {
                    message += '¬øQu√© deseas hacer?\n\n';
                    message += '1. Marcar fuera de servicio\n';
                    message += '2. Programar mantenimiento\n';
                    message += '3. Ver historial\n';
                    
                    const choice = prompt(message + '\nIngresa el n√∫mero de opci√≥n:');
                    
                    switch(choice) {
                        case '1':
                            maintenanceSystem.markOutOfService(resourceId);
                            break;
                        case '2':
                            document.getElementById('resourceSelect').value = resourceId;
                            maintenanceSystem.scheduleMaintenance();
                            break;
                        case '3':
                            alert(`üìã Historial de ${resourceId}:\n\n(Funcionalidad en desarrollo)`);
                            break;
                    }
                }
            } else {
                alert(message + 'Este recurso tiene mantenimiento pendiente.');
            }
        }

        function markOutOfService() {
            maintenanceSystem.markOutOfService();
        }

        function scheduleMaintenance() {
            maintenanceSystem.scheduleMaintenance();
        }

        function completeMaintenance() {
            maintenanceSystem.completeMaintenance();
        }

        function generateReport() {
            maintenanceSystem.generateReport();
        }

        function closeModal() {
            maintenanceSystem.closeModal();
        }

        function completeTask(taskId) {
            maintenanceSystem.completeTask(taskId);
        }

        function resetTestData() {
            if (confirm('¬øResetear todos los datos de prueba?\n\nEsto borrar√°:\n- Configuraci√≥n del establecimiento\n- Alquileres de prueba\n- Tareas de mantenimiento\n\n¬øContinuar?')) {
                // Limpiar localStorage
                localStorage.removeItem('zeus-establishment-config');
                localStorage.removeItem('zeus-rentals'); 
                localStorage.removeItem('zeus-maintenance-tasks');
                localStorage.removeItem('zeus-resource-status');
                
                // Reinicializar sistema
                maintenanceSystem = new MaintenanceSystem();
                
                alert('‚úÖ Datos de prueba reseteados y regenerados');
            }
        }

        // Configurar fecha m√≠nima en el selector
        window.addEventListener('DOMContentLoaded', () => {
            const dateInput = document.getElementById('scheduledDate');
            if (dateInput) {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                dateInput.min = now.toISOString().slice(0, 16);
            }
        });
    </script>
</body>
</html>